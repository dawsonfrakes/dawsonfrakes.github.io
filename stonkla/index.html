<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stonkla</title>
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
  <link rel="shortcut icon" href="favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
  <link rel="manifest" href="favicon/site.webmanifest" />
</head>
<body>
  <script type="module">
    import {StrictMode, useState, useEffect, useContext, useId, useRef, createContext, createElement as h} from "https://esm.sh/react@19/?dev";
    import ReactDOMClient from "https://esm.sh/react-dom@19/client?dev";
    import Dexie from "https://esm.sh/dexie?dev";
    import {useLiveQuery} from "https://esm.sh/dexie-react-hooks?dev";

    const TRANSLATIONS = {
      "en": {
        "translation-name": "English",
        "app-add-trade-button": "Add Trade",
        "app-settings-locale-label": "Locale:",
        "app-settings-theme-label": "Theme:",
        "app-settings-currency-label": "Currency:",
        "trade-execution-action-buy-button": "BUY",
        "trade-execution-action-sell-button": "SELL",
        "trade-execution-remove-execution-button": "Remove",
        "trade-entry-symbol-label": "Symbol:",
        "trade-entry-symbol-placeholder": "Symbol",
        "trade-entry-tags-label": "Tags:",
        "trade-entry-tags-placeholder": "Tags (tag1;tag2)",
        "trade-entry-time-label": "Time:",
        "trade-entry-time-placeholder": "Time",
        "trade-entry-quantity-label": "Quantity:",
        "trade-entry-quantity-placeholder": "Quantity",
        "trade-entry-price-label": "Price:",
        "trade-entry-price-placeholder": "Price",
        "trade-entry-fees-label": "Fees:",
        "trade-entry-fees-placeholder": "Fees",
        "trade-execution-add-execution-button": "Add Execution",
        "trade-entry-save-button": "Save",
        "trade-entry-cancel-button": "Cancel",
        "trade-stats-stats-header": "Statistics",
        "trade-stats-win-count-text": "Win Count:",
        "trade-stats-loss-count-text": "Loss Count:",
        "trade-stats-total-count-text": "Total Trades:",
        "trade-stats-win-percentage-text": "Win Percentage:",
        "trade-stats-largest-win-text": "Largest Win:",
        "trade-stats-largest-loss-text": "Largest Loss:",
        "trade-table-import-csv-button": "Import from CSV",
        "trade-table-export-csv-button": "Export to CSV",
        "trade-table-remove-all-trades-button": "Remove All Trades",
        "trade-table-remove-all-trades-confirmation": "Are you sure you want to remove all trades?",
        "trade-table-date-header": "Date",
        "trade-table-symbol-header": "Symbol",
        "trade-table-status-header": "Status",
        "trade-table-position-header": "Position",
        "trade-table-entry-total-header": "Entry Total",
        "trade-table-exit-total-header": "Exit Total",
        "trade-table-edit-header": "Edit",
        "trade-table-remove-header": "Remove",
        "trade-table-status-win-data": "WIN",
        "trade-table-status-loss-data": "LOSS",
        "trade-table-position-open-data": "OPEN",
        "trade-table-position-closed-data": "CLOSED",
        "trade-table-edit-button": "Edit",
        "trade-table-remove-button": "Remove",
        "app-made-with-love": "Made with ❤️ by Dfra",
      },
      "es": {
        "translation-name": "Español",
        "app-add-trade-button": "Agregar comercio",
        "app-settings-locale-label": "Lugar:",
        "app-settings-theme-label": "Tema:",
        "app-settings-currency-label": "Divisa:",
        "trade-execution-action-buy-button": "COMPRAR",
        "trade-execution-action-sell-button": "VENDER",
        "trade-execution-remove-execution-button": "Eliminar",
        "trade-entry-symbol-label": "Símbolo:",
        "trade-entry-symbol-placeholder": "Símbolo",
        "trade-entry-tags-label": "Etiquetas:",
        "trade-entry-tags-placeholder": "Etiquetas (tag1;tag2)",
        "trade-entry-time-label": "Tiempo:",
        "trade-entry-time-placeholder": "Tiempo",
        "trade-entry-quantity-label": "Cantidad:",
        "trade-entry-quantity-placeholder": "Cantidad",
        "trade-entry-price-label": "Precio:",
        "trade-entry-price-placeholder": "Precio",
        "trade-entry-fees-label": "Honorarios:",
        "trade-entry-fees-placeholder": "Honorarios",
        "trade-execution-add-execution-button": "Agregar ejecución",
        "trade-entry-save-button": "Ahorrar",
        "trade-entry-cancel-button": "Cancelar",
        "trade-stats-stats-header": "Estadística",
        "trade-stats-win-count-text": "Conteo de victorias:",
        "trade-stats-loss-count-text": "Recuento de pérdidas:",
        "trade-stats-total-count-text": "Operaciones totales:",
        "trade-stats-win-percentage-text": "Porcentaje de victorias:",
        "trade-stats-largest-win-text": "Mayor victoria:",
        "trade-stats-largest-loss-text": "La pérdida más grande:",
        "trade-table-import-csv-button": "Importar desde CSV",
        "trade-table-export-csv-button": "Exportar a CSV",
        "trade-table-remove-all-trades-button": "Eliminar todas las operaciones",
        "trade-table-remove-all-trades-confirmation": "¿Está seguro de que desea eliminar todas las operaciones?",
        "trade-table-date-header": "Fecha",
        "trade-table-symbol-header": "Símbolo",
        "trade-table-status-header": "Estado",
        "trade-table-position-header": "Posición",
        "trade-table-entry-total-header": "Total de entradas",
        "trade-table-exit-total-header": "Salida total",
        "trade-table-edit-header": "Editar",
        "trade-table-remove-header": "Eliminar",
        "trade-table-status-win-data": "GANAR",
        "trade-table-status-loss-data": "PÉRDIDA",
        "trade-table-position-open-data": "ABIERTO",
        "trade-table-position-closed-data": "CERRADO",
        "trade-table-edit-button": "Editar",
        "trade-table-remove-button": "Eliminar",
        "app-made-with-love": "Hecho con ❤️ por Dfra",
      },
    };

    const THEMES = {
      "suisei-dark": {
        "background-primary": "#3b4a62",
        "text-primary": "#dbdeeb",
        "text-secondary": "#affaff",
        "accent": "#fe9841",
      },
      "suisei-light": {
        "background-primary": "#c4b59d",
        "text-primary": "#242114",
        "text-secondary": "#500500",
        "accent": "#0167be",
      },
    };

    function currentMinute() {
      const date = new Date(new Date() - new Date().getTimezoneOffset() * 60 * 1000);
      date.setSeconds(0, 0);
      return date.toISOString().slice(0, -1);
    }

    function downloadTextFile(fileName, type, text) {
      const blob = new Blob([text], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.download = fileName;
      a.href = url;
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function csvToObjectArray(data) {
      const lines = data.split("\n");
      const headers = lines[0].split(",");
      return lines.slice(1).filter(line => line !== "").map(line => line.split(",").reduce((obj, value, i) => (obj[headers[i]] = value, obj), {}));
    }

    const db = new Dexie("stonkla");
    db.version(1).stores({
      trades: "++id, executions, tags",
    });

    const LocaleContext = createContext();
    const ThemeContext = createContext();
    const CurrencyContext = createContext();

    const TradeTable = ({editTrade, removeTrade}) => {
      const id = useId();
      const importFileRef = useRef();
      const {T, locale} = useContext(LocaleContext);
      const {C} = useContext(CurrencyContext);
      const trades = useLiveQuery(() => db.trades.toArray());

      if (!trades) return null;

      const importCSV = e => {
        e.preventDefault();
        if (importFileRef.current.files.length === 0) return;

        const file = importFileRef.current.files[0];
        const reader = new FileReader();
        reader.onload = async e => {
          const data = csvToObjectArray(e.target.result);
          importFileRef.current.value = "";
          let result = [];
          let i = 0;
          while (i < data.length) {
            const symbol = data[i].symbol;
            const tags = data[i].tags?.split(";").filter(tag => tag !== "") ?? [];
            const executions = [];
            do {
              executions.push({
                action: data[i].action,
                time: data[i].time,
                quantity: Number(data[i].quantity),
                price: Number(data[i].price),
                fees: Number(data[i].fees),
              });
              i += 1;
            } while (i < data.length && data[i - 1].id === data[i].id);
            result.push({
              symbol,
              executions,
              tags,
            });
          }
          await db.trades.bulkAdd(result);
        };
        reader.readAsText(file);
      };

      const exportCSV = () => {
        let result = "id,symbol,action,time,quantity,price,fees,tags\n";
        for (const trade of trades) {
          for (const execution of trade.executions) {
            result += trade.id;
            result += ",";
            result += trade.symbol;
            result += ",";
            result += execution.action;
            result += ",";
            result += execution.time;
            result += ",";
            result += execution.quantity;
            result += ",";
            result += execution.price;
            result += ",";
            result += execution.fees;
            result += ",";
            result += trade.tags.join(";");
            result += "\n";
          }
        }
        downloadTextFile("trades.csv", "text/csv", result);
      };

      const removeAllTrades = async () => trades.length !== 0 && confirm(T("trade-table-remove-all-trades-confirmation")) && await db.trades.clear();

      return h(
        "div",
        null,
        h(
          "form",
          {onSubmit: importCSV},
          h("input", {ref: importFileRef, type: "file", required: true}),
          h("button", null, T("trade-table-import-csv-button")),
        ),
        h("button", {onClick: exportCSV}, T("trade-table-export-csv-button")),
        h("button", {style: {color: "red"}, onClick: removeAllTrades}, T("trade-table-remove-all-trades-button")),
        h(
          "table",
          {style: {border: "1px solid"}},
          h(
            "thead",
            null,
            h(
              "tr",
              null,
              h("th", null, T("trade-table-date-header")),
              h("th", null, T("trade-table-symbol-header")),
              h("th", null, T("trade-table-status-header")),
              h("th", null, T("trade-table-position-header")),
              h("th", null, T("trade-table-entry-total-header")),
              h("th", null, T("trade-table-exit-total-header")),
              h("th", null, T("trade-table-edit-header")),
              h("th", null, T("trade-table-remove-header")),
            ),
          ),
          h(
            "tbody",
            null,
            trades.map(trade => h(
              "tr",
              {key: trade.id},
              h("td", null, new Date(trade.executions[0].time).toLocaleDateString(locale)),
              h("td", null, trade.symbol),
              h("td", null, trade.executions.reduce((acc, execution) => acc + execution.quantity * execution.price * (execution.action === "BUY" ? -1 : 1) - execution.fees, 0) >= -0.00001 ? T("trade-table-status-win-data") : T("trade-table-status-loss-data")),
              h("td", null, Math.abs(trade.executions.reduce((acc, execution) => acc + execution.quantity * (execution.action === "BUY" ? 1 : -1), 0)) < 0.0001 ? T("trade-table-position-closed-data") : T("trade-table-position-open-data")),
              h("td", null, C(trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price + execution.fees) * (execution.action === "BUY"), 0))),
              h("td", null, C(trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price - execution.fees) * (execution.action === "SELL"), 0))),
              h("td", null, h("button", {onClick: () => editTrade(trade.id)}, T("trade-table-edit-button"))),
              h("td", null, h("button", {onClick: () => removeTrade(trade.id)}, T("trade-table-remove-button"))),
            )),
          ),
        ),
      );
    };

    const TradeStats = () => {
      const {T, P} = useContext(LocaleContext);
      const {C} = useContext(CurrencyContext);
      const trades = useLiveQuery(() => db.trades.toArray());

      if (!trades) return null;

      const wins = trades.map(trade => trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price) * (execution.action === "BUY" ? -1 : 1) - execution.fees, 0) >= -0.00001 ? 1 : 0).reduce((acc, didWin) => acc + didWin, 0);
      const losses = trades.map(trade => trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price) * (execution.action === "BUY" ? -1 : 1) - execution.fees, 0) >= -0.00001 ? 0 : 1).reduce((acc, didLose) => acc + didLose, 0);
      const total = wins + losses;
      const average = wins / (total || 1);

      return h(
        "div",
        {style: {margin: "10px"}},
        h("h2", null, T("trade-stats-stats-header")),
        T("trade-stats-win-count-text") + " " + wins,
        h("br"),
        T("trade-stats-loss-count-text") + " " + losses,
        h("br"),
        T("trade-stats-total-count-text") + " " + total,
        h("br"),
        T("trade-stats-win-percentage-text") + " " + P(average),
        h("br"),
        T("trade-stats-largest-win-text") + " " + C(trades.map(trade => trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price) * (execution.action === "BUY" ? -1 : 1) - execution.fees, 0)).reduce((acc, net) => Math.max(acc, net), 0)),
        h("br"),
        T("trade-stats-largest-loss-text") + " " + C(trades.map(trade => trade.executions.reduce((acc, execution) => acc + (execution.quantity * execution.price) * (execution.action === "BUY" ? -1 : 1) + execution.fees, 0)).reduce((acc, net) => Math.min(acc, net), 0)),
      );
    };

    const TradeEntry = ({trade, setTrade, onSave, closeSelf}) => {
      const id = useId();
      const {T} = useContext(LocaleContext);

      const addExecution = () => {
        const executions = trade.executions;
        executions.push({
          action: executions.length !== 0 && executions[executions.length - 1].action === "BUY" ? "SELL" : "BUY",
          time: executions.length === 0 ? currentMinute() : executions[executions.length - 1].time,
          quantity: "",
          price: "",
          fees: "",
        });
        setTrade({...trade, executions});
      };

      const editExecution = (index, value) => {
        const executions = trade.executions;
        Object.assign(executions[index], value);
        setTrade({...trade, executions});
      };

      const removeExecution = index => {
        const executions = [...trade.executions.slice(0, index), ...trade.executions.slice(index + 1)];
        setTrade({...trade, executions});
      };

      const onSubmit = e => {
        e.preventDefault();

        onSave(trade);

        closeSelf();
      };

      useEffect(() => {
        if (trade.executions.length === 0) addExecution();
      }, []);

      return h(
        "div",
        null,
        h(
          "form",
          {onSubmit},
            h("label", {htmlFor: id + "-symbol"}, T("trade-entry-symbol-label")),
            h("input", {id: id + "-symbol", type: "text", required: true, placeholder: T("trade-entry-symbol-placeholder"), value: trade.symbol, onChange: e => setTrade({...trade, symbol: e.target.value.toUpperCase()})}),
            h("label", {htmlFor: id + "-tags"}, T("trade-entry-tags-label")),
            h("input", {id: id + "-tags", type: "text", placeholder: T("trade-entry-tags-placeholder"), value: trade.tags.join(";"), onChange: e => setTrade({...trade, tags: e.target.value.replace(/,/g, "").split(";")})}),
            trade.executions.map((execution, i) => h(
            "div",
            {key: i},
            h("button", {type: "button", onClick: () => removeExecution(i), disabled: trade.executions.length === 1}, T("trade-execution-remove-execution-button")),
            h("button", {type: "button", onClick: () => editExecution(i, {action: execution.action === "BUY" ? "SELL" : "BUY"})}, execution.action === "BUY" ? T("trade-execution-action-buy-button") : T("trade-execution-action-sell-button")),
            h("label", {htmlFor: id + "-time-" + i}, T("trade-entry-time-label")),
            h("input", {id: id + "-time-" + i, type: "datetime-local", required: true, step: 1, value: execution.time, onChange: e => editExecution(i, {time: e.target.value})}),
            h("label", {htmlFor: id + "-quantity-" + i}, T("trade-entry-quantity-label")),
            h("input", {id: id + "-quantity-" + i, type: "number", required: true, min: 0, step: 0.000000001, placeholder: T("trade-entry-quantity-placeholder"), value: execution.quantity, onChange: e => editExecution(i, {quantity: e.target.value})}),
            h("label", {htmlFor: id + "-price-" + i}, T("trade-entry-price-label")),
            h("input", {id: id + "-price-" + i, type: "number", required: true, min: 0, step: 0.0001, placeholder: T("trade-entry-price-placeholder"), value: execution.price, onChange: e => editExecution(i, {price: e.target.value})}),
            h("label", {htmlFor: id + "-fees-" + i}, T("trade-entry-fees-label")),
            h("input", {id: id + "-fees-" + i, type: "number", required: true, step: 0.0001, placeholder: T("trade-entry-fees-placeholder"), value: execution.fees, onChange: e => editExecution(i, {fees: e.target.value})}),
          )),
          h("button", {type: "button", onClick: addExecution}, T("trade-execution-add-execution-button")),
          h("button", null, T("trade-entry-save-button")),
        ),
        h("button", {onClick: closeSelf}, T("trade-entry-cancel-button")),
      );
    };

    const AppSettings = () => {
      const id = useId();
      const {T, locale, setLocale} = useContext(LocaleContext);
      const {theme, setTheme} = useContext(ThemeContext);
      const {currency, setCurrency} = useContext(CurrencyContext);

      return h(
        "div",
        null,
        h("label", {htmlFor: id + "-locale"}, T("app-settings-locale-label")),
        h(
          "select",
          {id: id + "-locale", defaultValue: locale, onChange: e => setLocale(e.target.value)},
          Object.keys(TRANSLATIONS).map(l => h("option", {key: l, value: l}, TRANSLATIONS[l]["translation-name"])),
        ),
        h("label", {htmlFor: id + "-theme"}, T("app-settings-theme-label")),
        h(
          "select",
          {id: id + "-theme", defaultValue: theme, onChange: e => setTheme(e.target.value)},
          Object.keys(THEMES).map(t => h("option", {key: t, value: t}, t)),
        ),
        h("label", {htmlFor: id + "-currency"}, T("app-settings-currency-label")),
        h(
          "select",
          {id: id + "-currency", defaultValue: currency, onChange: e => setCurrency(e.target.value)},
          ["USD", "GBP", "EUR"].map(c => h("option", {key: c, value: c}, c)),
        ),
      );
    };

    const App = () => {
      const defaultLocale = localStorage.getItem("locale") ?? navigator.language.slice(0, 2);
      const defaultTheme = localStorage.getItem("theme") ?? "suisei-dark";

      const [locale, setLocale] = useState(defaultLocale in TRANSLATIONS ? defaultLocale : Object.keys(TRANSLATIONS)[0]);
      const [theme, setTheme] = useState(defaultTheme in THEMES ? defaultTheme : Object.keys(THEMES)[0]);
      const [currency, setCurrency] = useState(localStorage.getItem("currency") ?? "USD");
      const [showTradeEntry, setShowTradeEntry] = useState(false);
      const [editedTrade, setEditedTrade] = useState();
      const [onTradeSave, setOnTradeSave] = useState();

      const T = key => TRANSLATIONS[locale][key] ?? console.error(`Key "${key}" not found in locale "${locale}".`);
      const S = key => THEMES[theme][key] ?? console.error(`Key "${key}" not found in theme "${theme}".`);;
      const C = amount => new Intl.NumberFormat(locale, {style: "currency", currency}).format(amount);
      const P = amount => new Intl.NumberFormat(locale, {style: "percent", maximumFractionDigits: 2}).format(amount);

      useEffect(() => localStorage.setItem("locale", locale), [locale]);
      useEffect(() => localStorage.setItem("theme", theme), [theme]);
      useEffect(() => localStorage.setItem("currency", currency), [currency]);

      const addTrade = () => {
        if (showTradeEntry) return;
        setEditedTrade({
          symbol: "",
          executions: [],
          tags: [],
        });
        setOnTradeSave(() => trade => db.trades.add({...trade, executions: trade.executions.map(execution => ({...execution, quantity: Number(execution.quantity), price: Number(execution.price), fees: Number(execution.fees)})), tags: trade.tags.filter(tag => tag !== "")}));
        setShowTradeEntry(true);
      };

      const editTrade = async id => {
          if (showTradeEntry) return;
          setEditedTrade(await db.trades.get(id));
          setOnTradeSave(() => trade => db.trades.put({...trade, executions: trade.executions.map(execution => ({...execution, quantity: Number(execution.quantity), price: Number(execution.price), fees: Number(execution.fees)})), tags: trade.tags.filter(tag => tag !== "")}));
          setShowTradeEntry(true);
      };

      const removeTrade = async id => await db.trades.delete(id);

      return h(LocaleContext.Provider, {value: {T, P, locale, setLocale}},
        h(ThemeContext.Provider, {value: {S, theme, setTheme}},
        h(CurrencyContext.Provider, {value: {C, currency, setCurrency}},
        h("style", null, `
          body {
            font-family: "Helvetica", "Arial", sans-serif;
            background-color: ${S("background-primary")};
            color: ${S("text-primary")};
          }

          a {
            color: ${S("accent")};
          }
        `),
        h("div", null, h("h1", null, "Stonkla")),
        h(AppSettings),
        showTradeEntry &&
          h(TradeEntry, {trade: editedTrade, setTrade: setEditedTrade, onSave: onTradeSave, closeSelf: () => setShowTradeEntry(false)}) ||
          h("button", {onClick: addTrade}, T("app-add-trade-button")),
        h(TradeStats),
        h(TradeTable, {editTrade, removeTrade}),
        h("footer", null, T("app-made-with-love")),
      )));
    };

    ReactDOMClient.createRoot(document.body).render(h(StrictMode, null, h(App)));
  </script>
</body>
</html>
