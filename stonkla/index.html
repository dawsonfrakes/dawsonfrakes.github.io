<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stonkla</title>
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
  <link rel="shortcut icon" href="favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
  <link rel="manifest" href="favicon/site.webmanifest" />
</head>
<body>
  <script type="module">
    import {Component, html, render} from 'https://esm.sh/htm/preact/standalone';
    import Dexie from "https://esm.sh/dexie";

    const db = new Dexie("stonkla");
    db.version(1).stores({
      trades: "++id,position,symbol,quantity,price,fee",
    });

    const TRANSLATIONS = {
      "en": {
        "translation-name": "English",
        "special-thanks": "Created using preact, htm, dexie",
        "made-with-love": "Made with ❤️ by Dfra",
        "new-trade-button": "New Trade",
        "new-trade-symbol": "Symbol",
        "new-trade-save": "Save Trade",
        "new-trade-cancel": "Cancel",
        "trade-table-position": "Position",
        "trade-table-symbol": "Symbol",
        "trade-table-quantity": "Quantity",
        "trade-table-price": "Price",
        "trade-table-fee": "Fee",
        "trade-table-remove": "Remove",
      },
      "fr": {
        "translation-name": "Français",
        "special-thanks": "Créé en utilisant preact, htm, dexie",
        "made-with-love": "Réalisé avec ❤️ par Dfra",
        "new-trade-button": "Nouveau commerce",
        "new-trade-symbol": "Symbole",
        "new-trade-save": "Enregistrer le commerce",
        "new-trade-cancel": "Annuler",
        "trade-table-position": "Position",
        "trade-table-symbol": "Symbole",
        "trade-table-quantity": "Quantité",
        "trade-table-price": "Prix",
        "trade-table-fee": "Frais",
        "trade-table-remove": "Retirer",
      },
      "he": {
        "translation-name": "עִברִית",
        "special-thanks": "נוצר באמצעות preact, htm, dexie",
        "made-with-love": "נעשה באהבה ❤️ על ידי Dfra",
        "new-trade-button": "טרייד חדש",
        "new-trade-symbol": "סֵמֶל",
        "new-trade-save": "שמור טרייד",
        "new-trade-cancel": "לְבַטֵל",
        "trade-table-position": "מַצָב",
        "trade-table-symbol": "סֵמֶל",
        "trade-table-quantity": "כַּמוּת",
        "trade-table-price": "מְחִיר",
        "trade-table-fee": "תַשְׁלוּם",
        "trade-table-remove": "לְהַסִיר",
      },
    };
    const THEMES = {
      "suisei-dark": {
        "background-primary": "#3b4a62",
        "text-primary": "#dbdeeb",
        "text-secondary": "#affaff",
        "accent": "#fe9841"
      },
      "suisei-light": {
        "background-primary": "#c4b59d",
        "text-primary": "#242114",
        "text-secondary": "#500500",
        "accent": "#0167be"
      },
    };

    class LocaleSelect extends Component {
      render({locale, setLocale}) {
        return html`
          <select value=${locale} onChange=${e => setLocale(e.currentTarget.value)}>
            ${Object.keys(TRANSLATIONS).map(key => html`<option key=${key} value=${key}>${TRANSLATIONS[key]["translation-name"]}</option>`)}
          </select>
        `;
      }
    }

    class ThemeSelect extends Component {
      render({theme, setTheme}) {
        return html`
          <select value=${theme} onChange=${e => setTheme(e.currentTarget.value)}>
            ${Object.keys(THEMES).map(key => html`<option key=${key} value=${key}>${key}</option>`)}
          </select>
        `;
      }
    }

    class NewTrade extends Component {
      state = {
        symbol: "",
      };

      onSymbolInput = e => {
        this.setState({symbol: e.currentTarget.value.toUpperCase()});
      };

      onSubmit = e => {
        e.preventDefault();

        db.trades.add({
          position: "Long Buy",
          symbol: this.state.symbol,
          quantity: 1,
          price: 0.25,
          fee: 0.25,
        });

        this.setState({
          symbol: "",
        });
      };

      render({T, cancel}) {
        return html`
          <div>
            <form style="display: inline-flex; flex-direction: column; align-items: center;" onSubmit=${this.onSubmit}>
              <input type="text" required placeholder=${T("new-trade-symbol")} value=${this.state.symbol} onInput=${this.onSymbolInput} />
              <button>${T("new-trade-save")}</button>
              <button type="none" onClick=${cancel}>${T("new-trade-cancel")}</button>
            </form>
          </div>
        `;
      }
    }

    class TradeTable extends Component {
      state = {
        trades: [],
      };

      render({T, C}) {
        db.trades.toArray().then(trades => this.setState({trades}));

        return html`
          <table style="border: 1px solid;">
            <thead>
              <tr>${["Position", "Symbol", "Quantity", "Price", "Fee", "Remove"].map(key => html`<td key=${key}>${T("trade-table-" + key.toLowerCase())}</td>`)}</tr>
            </thead>
            <tbody>
              ${this.state.trades.map(trade => html`<tr key=${trade.id}><td>${trade.position}</td><td>${trade.symbol}</td><td>${trade.quantity}</td><td>${C(trade.price)}</td><td>${C(trade.fee)}</td><td><button onClick=${() => db.trades.delete(trade.id)}>X</button></td></tr>`)}
            </tbody>
          </table>
        `;
      }
    }

    class App extends Component {
      state = {
        locale: localStorage.getItem("locale") ?? navigator.language.slice(0, 2),
        theme: localStorage.getItem("theme") ?? (window.matchMedia?.("(prefers-color-scheme:dark)")?.matches ? "suisei-dark" : "suisei-light"),
        newTrade: false,
      };

      componentDidMount() {
        if (!this.state.locale in TRANSLATIONS) this.setState({theme: Object.keys(TRANSLATIONS)[0]})
        if (!this.state.theme in THEMES) this.setState({theme: Object.keys(THEMES)[0]})
      }

      componentDidUpdate(prevProps, prevState) {
        if (this.state.locale !== prevState.locale) localStorage.setItem("locale", this.state.locale);
        if (this.state.theme !== prevState.theme) localStorage.setItem("theme", this.state.theme);
      }

      render() {
        const T = key => TRANSLATIONS[this.state.locale][key];
        const S = key => THEMES[this.state.theme][key];
        const C = amount => new Intl.NumberFormat(this.state.locale, {style: "currency", currency: "USD"}).format(amount);

        return html`
          <style>
            body {
              font-family: sans-serif;
              background-color: ${S("background-primary")};
              color: ${S("text-primary")};
            }

            a {
              color: ${S("accent")};
            }
          </style>
          <h1>Stonkla</h1>
          <${LocaleSelect} locale=${this.state.locale} setLocale=${locale => this.setState({locale})} />
          <${ThemeSelect} theme=${this.state.theme} setTheme=${theme => this.setState({theme})} />
          ${this.state.newTrade ? html`
            <${NewTrade} T=${T} cancel=${e => this.setState({newTrade: false})} />
          ` : html`
            <div><button onClick=${e => this.setState({newTrade: true})}>${T("new-trade-button")}</button></div>
          `}
          <${TradeTable} T=${T} C=${C} />
          <footer>
            ${T("special-thanks")}
            <br />
            ${T("made-with-love")}
          </footer>
        `;
      }
    }

    render(html`<${App} />`, document.body);
  </script>
</body>
</html>
